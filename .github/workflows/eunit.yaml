name: Test

on:
  push:
    branches:
      - 'main'
  pull_request:
  workflow_dispatch:

jobs:
  mac:
    name: macOS (${{ matrix.os }} ${{ matrix.otp }})
    strategy:
      fail-fast: false
      matrix:
        otp:
          - "27.3.4.2-1"
        rebar3:
          - "3.22.0"
        os:
          - macos-15

    runs-on: ${{ matrix.os }}
    steps:
      - uses: emqx/macos-erlang@f744c98139c0db83a10619587d4bae4fc49765a8 # v1.0.0
        with:
          otp-version: ${{ matrix.otp }}
          rebar3-version: ${{ matrix.rebar3 }}

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - run: ./build.sh
      - run: rebar3 eunit

  linux:
    name: linux (${{ matrix.os }} ${{ matrix.arch }} ${{ matrix.builder.otp }})
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu24.04
        arch:
          - amd64
          - arm64
        builder:
          - vsn: "5.5-5:1.18.3-27.3.4.2-1"
            otp: "27.3.4.2-1"

    runs-on: ubuntu-24.04${{ matrix.arch == 'arm64' && '-arm' || '' }}
    container: ghcr.io/emqx/emqx-builder/${{ matrix.builder.vsn }}-${{ matrix.os }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive
      - run: git config --global --add safe.directory $GITHUB_WORKSPACE
      - run: ./build.sh
      - run: rebar3 eunit
